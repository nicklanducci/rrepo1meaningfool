<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Vertical Live Text x4 • Test Locale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; background:#000; color:#fff; overflow:hidden; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* layer principale */
    .stage {
      position: fixed; inset: 0;
      display: flex; justify-content: center; align-items: center;
      border: 2px solid #444; /* bordo per vedere l’area stage */
      box-sizing: border-box;
    }

    .columns {
      display: flex; align-items: center; justify-content: center; gap: 6vw;
      border: 1px dashed #666; /* bordo per vedere il contenitore colonne */
      padding: 1rem;
      box-sizing: border-box;
    }

    .viewport {
      height: 90vh; width: min(16vw, 220px);
      overflow: hidden; position: relative;
      display: flex; justify-content: center; background:#000;
      border: 1px solid #888;  /* bordo per vedere il riquadro colonna */
      box-sizing: border-box;
    }
    .viewport.mode-left  { align-items: flex-end; }   /* testo appoggiato in basso */
    .viewport.mode-spine { align-items: flex-start; } /* testo appoggiato in alto */

    .line {
      writing-mode: vertical-rl;
      white-space: nowrap;
      line-height: 1.09;
      font-size: clamp(28px, 6vw, 120px);
      transform-origin: center;
      will-change: transform;
      user-select: none;
    }
    .line.left  { text-orientation: mixed;    transform: rotate(180deg) translateY(0); }
    .line.spine { text-orientation: sideways; transform: translateY(0); }

    .cursor {
      display:inline-block; width:1ch; text-align:center;
      animation: blink 1s step-end infinite;
    }
    .cursor::after { content:"▌"; }
    @keyframes blink { 50% { opacity:0; } }

    .controls {
      position: fixed; left: 0; right: 0; bottom: 10px;
      display: flex; gap: .5rem; justify-content: center;
      font-family: inherit;
    }
    button {
      background:#111; color:#fff; border:1px solid #333; border-radius:.5rem;
      padding:.6rem .8rem; font-size:16px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="columns">
      <div class="viewport mode-left"  id="viewport1">
        <div class="line left"  id="line1">
          <span id="text1"></span><span class="cursor" id="cursor1"></span>
        </div>
      </div>
      <div class="viewport mode-spine" id="viewport2">
        <div class="line spine" id="line2">
          <span id="text2"></span><span class="cursor" id="cursor2"></span>
        </div>
      </div>
      <div class="viewport mode-left"  id="viewport3">
        <div class="line left"  id="line3">
          <span id="text3"></span><span class="cursor" id="cursor3"></span>
        </div>
      </div>
      <div class="viewport mode-spine" id="viewport4">
        <div class="line spine" id="line4">
          <span id="text4"></span><span class="cursor" id="cursor4"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="restart">Restart animation</button>
  </div>

  <script>
    // ========= TEST SENTENCE (locale, niente API) =========
    const SAMPLE = "The sculpture exists only when unseen.";

    // ========= TYPING SPEED (uguale per tutte le colonne) =========
    const CHAR_MS   = 170;   // per carattere
    const SPACE_MS  = 280;   // dopo spazio
    const COMMA_MS  = 520;   // dopo virgola
    const PERIOD_MS = 1000;  // dopo . ! ? …
    const DASH_MS   = 650;   // dopo – — -
    const REDUCED_MOTION = matchMedia("(prefers-reduced-motion: reduce)").matches;

    // ========= SCROLL =========
    const LEFT_BOTTOM_ROOM_PX = 140;    // margine sotto il cursore per le colonne left
    const SPINE_TOP_ROOM_PX   = 140;    // margine sopra per spine
    const LERP_BASE           = 0.06;
    const LERP_BOOST          = 0.10;
    const LAG_THRESHOLD       = 36;

    function delayFor(ch){
      if (ch === " ") return CHAR_MS + SPACE_MS;
      if (/[,\u061B;]/.test(ch)) return CHAR_MS + COMMA_MS;
      if (/[.!?]/.test(ch))      return CHAR_MS + PERIOD_MS;
      if (/[\u2013\u2014-]/.test(ch)) return CHAR_MS + DASH_MS;
      if (ch === "\u2026") return CHAR_MS + PERIOD_MS;
      return CHAR_MS;
    }

    function setupTestColumn({ mode, viewportId, lineId, textId }) {
      const viewport = document.getElementById(viewportId);
      const line     = document.getElementById(lineId);
      const textSpan = document.getElementById(textId);

      const chars = Array.from(SAMPLE);

      let targetY = 0;
      let currentY = 0;

      function computeTargetY() {
        const contentH = line.scrollHeight;
        const viewH    = viewport.clientHeight;
        if (mode === "left") {
          const allowedH = Math.max(0, viewH - LEFT_BOTTOM_ROOM_PX);
          const excess   = contentH - allowedH;
          targetY = excess > 0 ? -excess : 0;
        } else {
          const allowedH = Math.max(0, viewH - SPINE_TOP_ROOM_PX);
          const excess   = contentH - allowedH;
          targetY = excess > 0 ? -excess : 0;
        }
      }

      function applyTransform() {
        if (mode === "left") {
          line.style.transform = `rotate(180deg) translateY(${currentY}px)`;
        } else {
          line.style.transform = `translateY(${currentY}px)`;
        }
      }

      // scroll morbido costante
      (function animateScroll() {
        requestAnimationFrame(animateScroll);
        if (REDUCED_MOTION) {
          currentY = targetY;
        } else {
          const lag  = targetY - currentY;
          const ease = Math.abs(lag) > LAG_THRESHOLD ? LERP_BOOST : LERP_BASE;
          currentY += lag * ease;
        }
        applyTransform();
      })();

      function startTyping() {
        textSpan.textContent = "";
        targetY = 0;
        currentY = 0;
        applyTransform();

        let i = 0;
        function typeNext() {
          if (i >= chars.length) return;
          const ch = chars[i++];
          textSpan.textContent += (ch === "\n") ? " " : ch;
          computeTargetY();
          setTimeout(typeNext, delayFor(ch));
        }
        setTimeout(typeNext, 600); // piccolo delay iniziale
      }

      // avvia subito
      startTyping();

      return { restart: startTyping };
    }

    const col1 = setupTestColumn({ mode:"left",  viewportId:"viewport1", lineId:"line1", textId:"text1" });
    const col2 = setupTestColumn({ mode:"spine", viewportId:"viewport2", lineId:"line2", textId:"text2" });
    const col3 = setupTestColumn({ mode:"left",  viewportId:"viewport3", lineId:"line3", textId:"text3" });
    const col4 = setupTestColumn({ mode:"spine", viewportId:"viewport4", lineId:"line4", textId:"text4" });

    // Bottone per riavviare l’animazione in tutte le colonne
    document.getElementById("restart").addEventListener("click", () => {
      col1.restart();
      col2.restart();
      col3.restart();
      col4.restart();
    });

    // Adatta lo scroll se cambia la dimensione della finestra
    addEventListener("resize", () => {
      // non ricalcoliamo qui il target, perché viene fatto a ogni lettera;
      // ma per sicurezza forziamo un leggero realineamento
    });
  </script>
</body>
</html>
