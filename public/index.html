<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Vertical x3 • Framed Rectangles with Underlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background:#000000;
      color:#fff;
      overflow:hidden;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-weight: 700;
    }

    .stage {
      position: fixed;
      inset: 0;
      background:#000000;
    }

    .frame {
      position:absolute;
      background:#ff5958;
      z-index:1;
      transition: background-color 5s linear;
    }

    .viewport {
      position: absolute;
      overflow: hidden;
      background:#000000;
      display:flex;
      justify-content:center;
      align-items:center;
      box-sizing: content-box;
      z-index:2;
    }

    .viewport-bg {
      position:absolute;
      inset:0;
      background:#000;
      opacity:0.7;
      pointer-events:none;
      z-index:1;
      overflow:hidden;
      visibility:hidden;
    }

    .viewport-bg video {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .viewport-bg.video-left  video { object-position: 0% center; }
    .viewport-bg.video-center video { object-position: 50% center; }
    .viewport-bg.video-right video { object-position: 100% center; }

    .inner {
      width:100%;
      height:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      pointer-events:none;
      position:relative;
      z-index:2;
      opacity:1;
      transition: opacity 0.2s linear;
    }

    .viewport.mode-left .inner { align-items:flex-end; padding-bottom:90px; }
    .viewport.mode-spine .inner { align-items:flex-start; padding-top:50px; }

    .line {
      writing-mode: vertical-rl;
      white-space: nowrap;
      line-height: 1.1;
      font-size: clamp(28px, 6vw, 120px);
      will-change: transform;
      user-select: none;
    }

    .line.left {
      text-orientation: mixed;
      transform-origin:center;
      transform: rotate(180deg) translateY(0);
    }

    .line.spine {
      text-orientation: sideways;
      transform-origin:top center;
      transform: translateY(0);
    }

    .line.left-big { font-size: clamp(28px, 7.2vw, 144px); }
    .line.right-big { font-size: clamp(28px, 6.3vw, 126px); }

    .cursor {
      display:inline-block;
      width:1ch;
      text-align:center;
      animation: blink 1s step-end infinite;
    }
    .cursor::after { content:"▌"; }

    @keyframes blink { 50% { opacity:0; } }
  </style>
</head>

<body>
<div class="stage">

  <!-- FRAMES -->
  <div class="frame" style="left:272px; top:33px; width:407px; height:1010px;"></div>
  <div class="frame" style="left:911px; top:14px; width:345px; height:995px;"></div>
  <div class="frame" style="left:1438px; top:11px; width:382px; height:995px;"></div>

  <!-- LEFT -->
  <div class="viewport mode-left" style="left:302px; top:63px; width:347px; height:950px;">
    <div class="viewport-bg video-left"></div>
    <div class="inner">
      <div class="line left left-big" id="line-left">
        <span id="text1"></span><span class="cursor"></span>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="viewport mode-spine" style="left:946px; top:44px; width:275px; height:935px;">
    <div class="viewport-bg video-center"></div>
    <div class="inner">
      <div class="line spine" id="line-center">
        <span id="text2"></span><span class="cursor"></span>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="viewport mode-left" style="left:1468px; top:41px; width:322px; height:935px;">
    <div class="viewport-bg video-right"></div>
    <div class="inner" style="padding-bottom:105px;">
      <div class="line left right-big" id="line-right">
        <span id="text3"></span><span class="cursor"></span>
      </div>
    </div>
  </div>

</div>

<script>
/* =============== TEXT LOGIC =============== */

const SAMPLE = " The sculpture exists only when unseen.";

const CHAR_MS=170, SPACE_MS=280, COMMA_MS=520, PERIOD_MS=1000, DASH_MS=650;
const BOTTOM_ROOM = 160;
const LERP_BASE=0.06, LERP_BOOST=0.10, LAG_THRESHOLD=36;
const REDUCED = matchMedia("(prefers-reduced-motion: reduce)").matches;

function delayFor(ch){
  if(ch===" ") return CHAR_MS+SPACE_MS;
  if(/[,\u061B;]/.test(ch)) return CHAR_MS+COMMA_MS;
  if(/[.!?]/.test(ch)) return CHAR_MS+PERIOD_MS;
  if(/[\u2013\u2014-]/.test(ch)) return CHAR_MS+DASH_MS;
  return CHAR_MS;
}

function setupColumn(viewport, line, isSpine, shiftPercent, shiftPx){
  const textSpan = line.querySelector("span");
  let targetY=0, currentY=0;
  const chars=[...SAMPLE];

  function computeY(){
    const contentH=line.scrollHeight;
    const viewH=viewport.clientHeight;
    const allowed=viewH - BOTTOM_ROOM;
    const excess=contentH - allowed;
    targetY = excess>0 ? -excess : 0;
  }

  function applyY(){
    const shiftX = `calc(${shiftPercent}% + ${shiftPx}px)`;
    if(isSpine){
      line.style.transform = `translateX(${shiftX}) translateY(${currentY}px)`;
    } else {
      line.style.transform =
        `translateX(${shiftX}) rotate(180deg) translateY(${currentY}px)`;
    }
  }

  (function anim(){
    requestAnimationFrame(anim);
    if(REDUCED){ currentY=targetY; applyY(); return; }
    const lag = targetY-currentY;
    const ease = Math.abs(lag)>LAG_THRESHOLD ? LERP_BOOST : LERP_BASE;
    currentY += lag * ease;
    applyY();
  })();

  function reset(){
    targetY=0; currentY=0; applyY();
  }

  function playOnce(onDone){
    textSpan.textContent="";
    reset();
    let i=0;

    function type(){
      if(i>=chars.length){
        if(onDone) onDone();
        return;
      }
      const ch=chars[i++];
      textSpan.textContent+=ch;
      computeY();
      setTimeout(type, delayFor(ch));
    }
    setTimeout(type,600);
  }

  return { playOnce };
}

/* init columns */
const vps=document.querySelectorAll(".viewport");
const lns=document.querySelectorAll(".line");

const columns=[
  setupColumn(vps[0],lns[0],false,-20,25),
  setupColumn(vps[1],lns[1],true,10,0),
  setupColumn(vps[2],lns[2],false,25,-55),
];

const inners=document.querySelectorAll(".inner");
function setTextVisible(v){
  inners.forEach(el=>el.style.opacity=v?1:0);
}

/* =============== VIDEO LOGIC (TRIPTYCH) =============== */

const VIDEO_SOURCES=["videos/1.mp4", "videos/2.mp4"];

function initTriptych(){
  const left=document.querySelector('.viewport-bg.video-left');
  const center=document.querySelector('.viewport-bg.video-center');
  const right=document.querySelector('.viewport-bg.video-right');

  const bgs=[left,center,right];
  const videos=bgs.map(bg=>{
    const v=document.createElement("video");
    v.muted=true; v.autoplay=false; v.loop=false;
    v.playsInline=true; v.setAttribute("playsinline","true");
    v.setAttribute("webkit-playsinline","true");
    bg.appendChild(v);
    return v;
  });

  function setVisible(v){
    bgs.forEach(bg=>bg.style.visibility=v?"visible":"hidden");
  }

  function playSequence(order,done){
    let index=0;

    function play(i){
      const src=VIDEO_SOURCES[order[i]]+"?v="+Date.now();
      videos.forEach(v=>v.src=src);

      videos[0].onloadedmetadata=()=>{
        /* ← the EXACT moment video starts */
        setTextVisible(false);
        setVisible(true);

        videos.forEach(v=>{
          v.currentTime=0;
          v.play().catch(()=>{});
        });
      };

      videos[0].onended=()=>{
        if(i+1<order.length){
          play(i+1);
        } else {
          videos.forEach(v=>{
            v.pause(); v.removeAttribute("src"); v.load();
          });
          setVisible(false);
          if(done) done();
        }
      };
    }

    play(index);
  }

  return { playSequence };
}

const triptych = initTriptych();

function randomOrder(){
  const first = Math.round(Math.random());
  return [first, first===0?1:0];
}

/* =============== ORCHESTRATION =============== */

function startTextPhase(){
  setTextVisible(true);

  columns[0].playOnce(()=>{
    setTimeout(startVideoPhase,1000);
  });
  columns[1].playOnce();
  columns[2].playOnce();
}

function startVideoPhase(){
  const order = randomOrder();
  triptych.playSequence(order, ()=>startTextPhase());
}

startTextPhase();


/* FRAME COLORS */
const FRAME_COLORS=["#ff5958","#0092a3","#006cda"];
let idx=0;
setInterval(()=>{
  idx = (idx+1)%3;
  document.querySelectorAll('.frame')
    .forEach(f=>f.style.backgroundColor=FRAME_COLORS[idx]);
},60000);

</script>
</body>
</html>
