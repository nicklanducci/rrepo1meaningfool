<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Vertical x3 • Template Background Test (Scrolling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background:#000;
      color:#fff;
      overflow:hidden;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    /* Full-screen background with the 1920x1080 template */
    .stage {
      position: fixed;
      inset: 0;
      background: url("rearprojectiontemplate.jpg") center center / cover no-repeat;
    }

    /* Each viewport sits on top of one blue rectangle (coordinates from 1920x1080) */
    .viewport {
      position: absolute;
      overflow: hidden;
      display: flex;
      justify-content: center;   /* horizontal centering inside the bar */
      align-items: flex-end;     /* start from bottom; we scroll upward */
      box-sizing: border-box;
      /* uncomment to debug bounding boxes:
      border: 1px solid rgba(255,255,255,0.4);
      */
    }

    /* left/right columns: bottom-up rotated text */
    .line.left {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      white-space: nowrap;
      line-height: 1.09;
      font-size: clamp(28px, 6vw, 120px);
      transform-origin: center;
      transform: rotate(180deg) translateY(0);
      will-change: transform;
      user-select: none;
    }

    /* middle column: spine orientation, bottom-aligned but sideways text */
    .line.spine {
      writing-mode: vertical-rl;
      text-orientation: sideways;
      white-space: nowrap;
      line-height: 1.09;
      font-size: clamp(28px, 6vw, 120px);
      transform-origin: center;
      transform: translateY(0);
      will-change: transform;
      user-select: none;
    }

    .cursor {
      display:inline-block;
      width:1ch;
      text-align:center;
      animation: blink 1s step-end infinite;
    }
    .cursor::after { content:"▌"; }

    @keyframes blink { 50% { opacity:0; } }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Column 1: x=308, y=78, w=317, h=935 on 1920x1080 -->
    <div
      class="viewport"
      id="viewport1"
      style="
        left:16.0417%;
        top:7.2222%;
        width:16.5104%;
        height:86.5741%;
      "
    >
      <div class="line left" id="line1">
        <span id="text1"></span><span class="cursor" id="cursor1"></span>
      </div>
    </div>

    <!-- Middle column (spine): x=939, y=44, w=265, h=935 -->
    <div
      class="viewport"
      id="viewport2"
      style="
        left:48.9063%;
        top:4.0741%;
        width:13.8021%;
        height:86.5741%;
      "
    >
      <div class="line spine" id="line2">
        <span id="text2"></span><span class="cursor" id="cursor2"></span>
      </div>
    </div>

    <!-- Column 3: x=1468, y=41, w=322, h=935 -->
    <div
      class="viewport"
      id="viewport3"
      style="
        left:76.4583%;
        top:3.7963%;
        width:16.7708%;
        height:86.5741%;
      "
    >
      <div class="line left" id="line3">
        <span id="text3"></span><span class="cursor" id="cursor3"></span>
      </div>
    </div>
  </div>

  <script>
    // ===== TEXT (loop, no API) =====
    const SAMPLE = "The sculpture exists only when unseen.";

    // ===== TYPING SPEED (same as before: slow & readable) =====
    const CHAR_MS   = 170;
    const SPACE_MS  = 280;
    const COMMA_MS  = 520;
    const PERIOD_MS = 1000;
    const DASH_MS   = 650;

    function delayFor(ch) {
      if (ch === " ") return CHAR_MS + SPACE_MS;
      if (/[,\u061B;]/.test(ch)) return CHAR_MS + COMMA_MS;
      if (/[.!?]/.test(ch))      return CHAR_MS + PERIOD_MS;
      if (/[\u2013\u2014-]/.test(ch)) return CHAR_MS + DASH_MS;
      if (ch === "\u2026") return CHAR_MS + PERIOD_MS;
      return CHAR_MS;
    }

    // ===== SCROLL SETTINGS (same for all columns) =====
    const BOTTOM_ROOM_PX = 160;  // space reserved under the cursor
    const LERP_BASE      = 0.06;
    const LERP_BOOST     = 0.10;
    const LAG_THRESHOLD  = 36;
    const REDUCED_MOTION = matchMedia("(prefers-reduced-motion: reduce)").matches;

    function setupColumn({ mode, viewportId, lineId, textId }) {
      const viewport = document.getElementById(viewportId);
      const line     = document.getElementById(lineId);
      const textSpan = document.getElementById(textId);

      const chars = Array.from(SAMPLE);

      let targetY = 0;
      let currentY = 0;

      function computeTargetY() {
        const contentH = line.scrollHeight;
        const viewH    = viewport.clientHeight;
        const allowedH = Math.max(0, viewH - BOTTOM_ROOM_PX);
        const excess   = contentH - allowedH;
        targetY = excess > 0 ? -excess : 0;
      }

      function applyTransform() {
        if (mode === "left") {
          line.style.transform = `rotate(180deg) translateY(${currentY}px)`;
        } else {
          // spine: bottom-aligned, sideways, but scrolls up the same way
          line.style.transform = `translateY(${currentY}px)`;
        }
      }

      // smooth scrolling loop per column
      (function animateScroll() {
        requestAnimationFrame(animateScroll);
        if (REDUCED_MOTION) {
          currentY = targetY;
        } else {
          const lag  = targetY - currentY;
          const ease = Math.abs(lag) > LAG_THRESHOLD ? LERP_BOOST : LERP_BASE;
          currentY += lag * ease;
        }
        applyTransform();
      })();

      function startLoop() {
        textSpan.textContent = "";
        targetY = 0;
        currentY = 0;
        applyTransform();

        let i = 0;

        function typeNext() {
          if (i >= chars.length) {
            // phrase finished → short pause, then loop again
            setTimeout(startLoop, 1200);
            return;
          }
          const ch = chars[i++];
          textSpan.textContent += (ch === "\n") ? " " : ch;
          computeTargetY();
          setTimeout(typeNext, delayFor(ch));
        }

        setTimeout(typeNext, 600);
      }

      startLoop();
    }

    // Set up the three columns
    setupColumn({ mode:"left",  viewportId:"viewport1", lineId:"line1", textId:"text1" });
    setupColumn({ mode:"spine", viewportId:"viewport2", lineId:"line2", textId:"text2" });
    setupColumn({ mode:"left",  viewportId:"viewport3", lineId:"line3", textId:"text3" });

    // No extra resize handling needed: computeTargetY runs as text grows,
    // and the viewports are percentage-based.
  </script>
</body>
</html>
