<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Vertical Test x3 • Template Background</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    /* Stage = full screen, with background template */
    .stage {
      position: fixed;
      inset: 0;
      background: url("rearprojectiontemplate.jpg") center center / cover no-repeat;
    }

    /* Each viewport will be absolutely positioned over a blue bar
       (coordinates derived from the 1920x1080 template). */
    .viewport {
      position: absolute;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: flex-end; /* testo appoggiato in basso */
      /* DEBUG: per vedere i bordi, decommenta la riga sotto */
      /* border: 1px solid rgba(255,255,255,0.4); */
    }

    /* Vertical line of text */
    .line {
      writing-mode: vertical-rl;
      white-space: nowrap;
      line-height: 1.09;
      font-size: clamp(28px, 6vw, 120px);
      transform-origin: center;
      will-change: transform;
      user-select: none;
    }

    /* bottom-up (rotate 180°) */
    .line.left {
      text-orientation: mixed;
      transform: rotate(180deg) translateY(0);
    }

    /* cursor inline alla fine del testo */
    .cursor {
      display: inline-block;
      width: 1ch;
      text-align: center;
      animation: blink 1s step-end infinite;
    }
    .cursor::after { content: "▌"; }

    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Colonna 1: x=308, y=78, w=317, h=935 su 1920x1080 -->
    <div
      class="viewport"
      id="viewport1"
      style="
        left:16.0417%;
        top:7.2222%;
        width:16.5104%;
        height:86.5741%;
      "
    >
      <div class="line left" id="line1">
        <span id="text1"></span><span class="cursor" id="cursor1"></span>
      </div>
    </div>

    <!-- Colonna 2: x=939, y=44, w=265, h=935 -->
    <div
      class="viewport"
      id="viewport2"
      style="
        left:48.9063%;
        top:4.0741%;
        width:13.8021%;
        height:86.5741%;
      "
    >
      <div class="line left" id="line2">
        <span id="text2"></span><span class="cursor" id="cursor2"></span>
      </div>
    </div>

    <!-- Colonna 3: x=1468, y=41, w=322, h=935 -->
    <div
      class="viewport"
      id="viewport3"
      style="
        left:76.4583%;
        top:3.7963%;
        width:16.7708%;
        height:86.5741%;
      "
    >
      <div class="line left" id="line3">
        <span id="text3"></span><span class="cursor" id="cursor3"></span>
      </div>
    </div>
  </div>

  <script>
    // ===== TEST SENTENCE (no API) =====
    const SAMPLE = "The sculpture exists only when unseen.";

    // ===== TYPING SPEED =====
    const CHAR_MS   = 170;   // base per carattere
    const SPACE_MS  = 280;   // dopo spazio
    const COMMA_MS  = 520;   // dopo , ;
    const PERIOD_MS = 1000;  // dopo . ! ? …
    const DASH_MS   = 650;   // dopo – — -
    const REDUCED_MOTION = matchMedia("(prefers-reduced-motion: reduce)").matches;

    // ===== SCROLL (morbido, costante) =====
    const BOTTOM_ROOM_PX = 180;  // spazio sotto il cursore
    const LERP_BASE      = 0.06;
    const LERP_BOOST     = 0.10;
    const LAG_THRESHOLD  = 36;

    function delayFor(ch) {
      if (ch === " ") return CHAR_MS + SPACE_MS;
      if (/[,\u061B;]/.test(ch)) return CHAR_MS + COMMA_MS;
      if (/[.!?]/.test(ch))      return CHAR_MS + PERIOD_MS;
      if (/[\u2013\u2014-]/.test(ch)) return CHAR_MS + DASH_MS;
      if (ch === "\u2026") return CHAR_MS + PERIOD_MS;
      return CHAR_MS;
    }

    function setupColumn(viewportId, lineId, textId) {
      const viewport = document.getElementById(viewportId);
      const line     = document.getElementById(lineId);
      const textSpan = document.getElementById(textId);

      const chars = Array.from(SAMPLE);

      let targetY = 0;
      let currentY = 0;

      function computeTargetY() {
        const contentH = line.scrollHeight;
        const viewH    = viewport.clientHeight;
        const allowedH = Math.max(0, viewH - BOTTOM_ROOM_PX);
        const excess   = contentH - allowedH;
        targetY = excess > 0 ? -excess : 0;
      }

      function applyTransform() {
        line.style.transform = `rotate(180deg) translateY(${currentY}px)`;
      }

      (function animateScroll() {
        requestAnimationFrame(animateScroll);
        if (REDUCED_MOTION) {
          currentY = targetY;
        } else {
          const lag  = targetY - currentY;
          const ease = Math.abs(lag) > LAG_THRESHOLD ? LERP_BOOST : LERP_BASE;
          currentY += lag * ease;
        }
        applyTransform();
      })();

      function startTyping() {
        textSpan.textContent = "";
        targetY = 0;
        currentY = 0;
        applyTransform();

        let i = 0;
        function typeNext() {
          if (i >= chars.length) return;
          const ch = chars[i++];
          textSpan.textContent += (ch === "\n") ? " " : ch;
          computeTargetY();
          setTimeout(typeNext, delayFor(ch));
        }
        setTimeout(typeNext, 800);
      }

      startTyping();
      return { restart: startTyping };
    }

    const col1 = setupColumn("viewport1", "line1", "text1");
    const col2 = setupColumn("viewport2", "line2", "text2");
    const col3 = setupColumn("viewport3", "line3", "text3");

    // (se vuoi aggiungere un bottone per restart, puoi usare col1.restart(), col2.restart(), col3.restart())
    window.addEventListener("resize", () => {
      // il targetY viene ricalcolato man mano che scrive; qui non serve altro.
    });
  </script>
</body>
</html>
